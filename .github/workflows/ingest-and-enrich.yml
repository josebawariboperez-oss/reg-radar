name: ingest-and-enrich

on:
  schedule:
    - cron: "0 6 * * *"   # 06:00 UTC -> Ingesta
    - cron: "0 7 * * *"   # 07:00 UTC -> Enriquecimiento
  workflow_dispatch: {}    # Lanzamiento manual

env:
  PYTHONUNBUFFERED: "1"

jobs:
  ingest:
    if: github.event_name == 'schedule' && contains(toJson(github.event.schedule), '0 6')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Ingest Qatar
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python run_save.py --country Qatar --limit 50

  enrich:
    if: github.event_name == 'schedule' && contains(toJson(github.event.schedule), '0 7') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Enrich pending
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: gpt-4o-mini
        run: |
          python enrich.py --limit 100
